# Swagger:
You can access to REST api at url `<backend:7771>/api/swagger`

# Web Socket Communications:
Url for bringing up a websocket connection is:
`wss://<backend:7771>/api/v1/run/events/{containerid}` 

Where `containerid` is the alphanumeric id that is sent in response to a `/run/new` REST call.

More that one client can be connected to one container: the input to that instance will be the sum of all inputs, while the output will be fanned out to all clients.

## Client message format
Once the communication is established, the client can send JSON messages in this format:
```json
{
	"line": "line entered by the user\n",
	"cmd":"out of band commands",
	"code": "SDK code to be executed"
}
```
Each parameter can be missing if empty not relevant.
If the first one ("line") is set, is represent the line interactively sent by the user. It weill be sent to the container standard input. 

Eventual control characters,such as newlines `\n`, **must** be explicitly sent by the client.

So a bash command to list files should be:
```json
{"line":"ls\n"}
```

It is possible to send out-of-band commands, using the "cmd" parameter. At the moment, the only supported command are "dump", which will provide the immudb tree, and "exec", which will execute the code supplied by the "code" parameter with a python interpreter.


## Server message format
Server will produce JSON messages in this format
```json
{
	"timestamp": 1617367545.01234,
	"type": "console|immudb|exec"
	# type=console
	"flux": "stdin|stdout",
	"line": "interactive output",
	# type=immudb
	"immudb": "encoded immudb data folder tarball",
	"tree": "base64encoded tree representation",
	"token": "state file content",
	"verified": true,
	# type=exec
	"lines": [
	    { "timestamp": 1617367545.01234,
	      "flux": "stdin|stdout",
	      "line": "n-th python script output line"},
	]
}
```

 - "timestamp" is of course the epoch in which the message is created, flux can be `stdin` or `stdout` and
 - "line" contains the output generated by the live container, usually (but not necessarily) in response to a user input. 
 - "immudb" contains the base64-encoded representation of immudb "/data" folder tarball (i.e., the whole database status).
 - "tree" contains the base64-encoded representation of the tree status, in the same way used in the non-interactive containers.
 - "token" contains the state file used by the client to cryptographically validate server output
 - "verified" is a boolean that is set to `true` when the server state is cryptographically verified by the client
 - in case of "exec" request, the server fills the "lines" parameter with the script output lines.
 
All values except "timestamp" can be omitted if empty or not relevant: usually container output doesn't have "tree", "token" or "verified" values. Out-of-band commands, instead, have no "flux" or "line" fields.
